<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Galaxy Defender — Mission</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="wrap">
  <header>
    <h1>Galaxy Defender — Mission: Save the Sector</h1>
    <div class="hud">
      <div class="chip">Score: <strong id="score">0</strong></div>
      <div class="chip">Lives: <strong id="lives">3</strong></div>
      <div class="chip">Kills: <strong id="kills">0</strong>/<strong id="goal">50</strong></div>
      <div class="controls">
        <button id="startBtn">Start</button>
        <button id="pauseBtn" class="ghost">Pause</button>
        <button id="restartBtn" class="ghost">Restart</button>
      </div>
    </div>
  </header>

  <div id="stage">
    <div id="canvasWrap">
      <canvas id="game" width="980" height="600"></canvas>
      <div class="small" style="margin-top:8px">Move mouse left/right — ship follows the guide line. Click or hold mouse to shoot. Destroy <span id="goalLabel">50</span> enemies to win. Remember you have only 3 chances. Let's go!</div>
    </div>

    <aside>
      <div class="panel">
        <div class="stat"><div>Wave</div><div id="wave">1</div></div>
        <div class="stat"><div>Weapon</div><div id="weapon">Single</div></div>
        <div class="stat"><div>Power-up</div><div id="power">None</div></div>

        <div style="padding-top:10px">
          <div style="font-weight:700;margin-bottom:6px">Legend</div>
          <div class="legend-row"><div class="dot" style="background:linear-gradient(45deg,#ff7b7b,#ff2d55);box-shadow:0 0 12px #ff2d55"></div><div>Enemy (red) — hostile</div></div>
          <div class="legend-row"><div class="dot" style="background:linear-gradient(45deg,#ffd580,#ffb84d);box-shadow:0 0 12px #ffd580"></div><div>Stronger enemy (amber)</div></div>
          <div class="legend-row"><div class="dot" style="background:linear-gradient(45deg,#7fffd4,#56ffe6);box-shadow:0 0 14px #56ffe6"></div><div>Power-up (cyan) — pick me!</div></div>
          <div class="legend-row"><div class="dot" style="background:linear-gradient(45deg,#6bb0ff,#8a6bff);box-shadow:0 0 14px #6bb0ff"></div><div>Boss (purple)</div></div>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="panel small">
        <div style="font-weight:700;margin-bottom:6px">Goal</div>
        <div>Destroy <strong id="goalText">50</strong> enemies. Final boss comes at 50 kills. Victory on final boss defeat.</div>
      </div>

      <footer>
        Tip: <strong>Rapid-fire</strong> power-ups make the run much easier.
      </footer>
    </aside>
  </div>
</div>


<!-- Authentication Modal -->
<div id="authModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100;background:rgba(0,0,0,0.7)">
  <div style="background:#222;padding:32px 28px;border-radius:14px;min-width:320px;box-shadow:0 0 24px #000;text-align:center;color:#fff">
    <h2>Login to Play</h2>
    <input type="text" id="login-username" placeholder="Username" style="width:100%;margin-bottom:8px;padding:8px;border-radius:4px;border:none" />
    <input type="password" id="login-password" placeholder="Password" style="width:100%;margin-bottom:8px;padding:8px;border-radius:4px;border:none" />
    <button onclick="login()" style="width:100%;padding:10px;margin-bottom:8px;background:#0078d7;color:#fff;border:none;border-radius:4px;font-weight:bold">Login</button>
    <div id="login-result" style="margin-bottom:12px;color:#ff7b7b"></div>
    <hr style="margin:16px 0;border:0;border-top:1px solid #444">
    <h3>Register</h3>
    <input type="text" id="register-username" placeholder="Username" style="width:100%;margin-bottom:8px;padding:8px;border-radius:4px;border:none" />
    <input type="email" id="register-email" placeholder="Email" style="width:100%;margin-bottom:8px;padding:8px;border-radius:4px;border:none" />
    <input type="password" id="register-password" placeholder="Password" style="width:100%;margin-bottom:8px;padding:8px;border-radius:4px;border:none" />
    <button onclick="register()" style="width:100%;padding:10px;background:#28a745;color:#fff;border:none;border-radius:4px;font-weight:bold">Register</button>
    <div id="register-result" style="margin-top:8px;color:#ffd580"></div>
  </div>
</div>

<div id="overlay" style="position:fixed;inset:0;display:none;pointer-events:none;align-items:center;justify-content:center;z-index:50">
  <div id="overlayCard" style="background:rgba(2,4,10,0.9);padding:28px;border-radius:12px;color:#e6fff6;text-align:center">
    <h2 id="overlayTitle" style="margin:0 0 10px 0"></h2>
    <div id="overlayText" style="margin-bottom:14px"></div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="overlayRestart">Restart</button>
    </div>
  </div>
</div>

<script>
const API_BASE = 'http://localhost:5066/api'; // Updated to match backend port
let jwtToken = localStorage.getItem('jwtToken') || '';


// Show login modal on page load, but do NOT block or disable the game
window.addEventListener('DOMContentLoaded', function() {
  document.getElementById('authModal').style.display = 'flex';
  document.body.style.overflow = '';
});

function showAuthModal() {
  document.getElementById('authModal').style.display = 'flex';
  document.body.style.overflow = '';
}
function hideAuthModal() {
  document.getElementById('authModal').style.display = 'none';
  document.body.style.overflow = '';
}

async function login() {
  const username = document.getElementById('login-username').value;
  const password = document.getElementById('login-password').value;
  const resultDiv = document.getElementById('login-result');
  resultDiv.innerText = 'Logging in...';
  try {
    const res = await fetch(`${API_BASE}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    let data = {};
    try { data = await res.json(); } catch {}
    if (res.ok && data.token) {
      jwtToken = data.token;
      localStorage.setItem('jwtToken', jwtToken);
      localStorage.setItem('loggedInUser', username);
      resultDiv.innerText = 'Login successful!';
      setTimeout(() => {
        hideAuthModal();
        window.dispatchEvent(new CustomEvent('user-authenticated', { detail: { token: jwtToken, username } }));
        if (typeof window.resetGame === 'function') window.resetGame();
      }, 700);
    } else {
      resultDiv.innerText = data.error || 'Login failed. Check your username and password.';
    }
  } catch (err) {
    resultDiv.innerText = 'Network error. Backend API may not be running or CORS is blocking.';
  }
}

async function register() {
  const username = document.getElementById('register-username').value;
  const email = document.getElementById('register-email').value;
  const password = document.getElementById('register-password').value;
  const resultDiv = document.getElementById('register-result');
  resultDiv.innerText = 'Registering...';
  try {
    const res = await fetch(`${API_BASE}/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, email, password })
    });
    let data = {};
    try { data = await res.json(); } catch {}
    if (res.ok && data.message) {
      resultDiv.innerText = data.message;
    } else {
      resultDiv.innerText = data.error || 'Registration failed. Try a different username/email.';
    }
  } catch (err) {
    resultDiv.innerText = 'Network error. Backend API may not be running or CORS is blocking.';
  }
}

function enableGameUI() {
  // Enable game controls, start game, etc. You can add more logic here if needed.
  document.getElementById('startBtn').disabled = false;
  document.getElementById('pauseBtn').disabled = false;
  document.getElementById('restartBtn').disabled = false;
}

window.onload = function() {
  // Game is always enabled, login is independent
};
</script>
<script src="script.js" defer></script>
</body>
</html>